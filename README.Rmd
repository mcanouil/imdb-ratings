---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

# My IMDb Ratings Analysis

<!-- badges: start -->
[![License](https://img.shields.io/github/license/mcanouil/imdb-ratings)](LICENSE)
[![Render README](https://github.com/mcanouil/imdb-ratings/actions/workflows/render-readme.yaml/badge.svg)](https://github.com/mcanouil/imdb-ratings/actions/workflows/render-readme.yaml)
<!-- badges: end -->

```{r}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "media/",
  fig.process = function(path) {
    new_path <- sub("-1\\.", ".", path)
    file.copy(path, new_path, overwrite = TRUE)
    on.exit(unlink(normalizePath(path)))
    new_path
  },
  dev = c("svglite", "ragg_png"),
  echo = FALSE,
  message = FALSE
)

pkgs <- c(
  "targets",
  "here", "data.table", "lubridate", "showtext", "ggplot2",
  "scales", "ggtext", "gganimate", "patchwork", "xml2",
  "rvest", "glue", "svglite", "ragg",
   "gifski", "tweenr", "transformr"
)
# renv::snapshot(packages = c("rmarkdown", pkgs))
invisible(sapply(
  X = pkgs,
  FUN = library, character.only = TRUE, quietly = TRUE
))

tar_unscript()

font <- "Alegreya Sans"
sysfonts::font_add_google(font, font, regular.wt = 300)
showtext::showtext_auto()
source(here::here("R", "ggplot2-mc.R"))
ggplot2::theme_set(theme_mc(base_size = 11, base_family = font))

ggplot2::theme_update(
  plot.title.position = "plot",
  plot.caption.position = "plot",
  plot.title = ggplot2::element_text(), # ggtext::element_markdown(),
  plot.subtitle = ggtext::element_markdown(face = "italic"),
  plot.caption = ggtext::element_markdown(face = "italic"),
  axis.title.x = ggtext::element_markdown(),
  axis.text.x = ggtext::element_markdown(),
  axis.text.x.top = ggtext::element_markdown(),
  axis.title.y = ggtext::element_markdown(),
  axis.text.y = ggtext::element_markdown()
)

options(
  ggplot2.discrete.colour = function(...) ggplot2::scale_colour_viridis_d(..., begin = 0.15, end = 0.85),
  ggplot2.discrete.fill = function(...) ggplot2::scale_fill_viridis_d(..., begin = 0.15, end = 0.85),
  ggplot2.continuous.colour = function(...) ggplot2::scale_colour_viridis_c(..., begin = 0.15, end = 0.85),
  ggplot2.continuous.fill = function(...) ggplot2::scale_fill_viridis_c(..., begin = 0.15, end = 0.85)
)
```

```{targets workflow, tar_globals = TRUE}
tar_option_set(
  packages = c(
    "here", "data.table", "lubridate", "showtext", "ggplot2",
    "scales", "ggtext", "gganimate", "patchwork", "xml2",
    "rvest", "glue"
  )
)

font <- "Alegreya Sans"
fig_caption <- NULL # "&copy; Micka&euml;l '<i style='color:#21908CFF;'>Coeos</i>' Canouil"

get_metascore <- function(x) {
  sapply(
    X = paste0("https://www.imdb.com/title/", x, "/"),
    FUN = function(y) {
      result <- as.numeric(rvest::html_text(
        x = rvest::html_node(
          x = xml2::read_html(x = paste0(y, "criticreviews")),
          css = "div.metascore"
        )
      )) / 10

      if (is.numeric(result) && !is.na(result)) {
        result
      } else {
        NA
      }
    }
  )
}

ratings_histogram <- function(ratings, static) {
  who_colours <- `names<-`(
    scales::viridis_pal(begin = 0.5, direction = -1)(3),
    c("COEOS", "METASCORE", "IMDB USERS")
  )

  text_legend <- glue::glue_collapse(
    glue::glue("<b style='color:{who_colours};'>{names(who_colours)}</b>"),
    sep = ", ",
    last = " and "
  )

  ratings_long <- data.table::melt(
    data = ratings[
      j = c(grep("rating$", names(ratings), value = TRUE)) := lapply(.SD, as.numeric),
      .SDcols = grep("rating$", names(ratings), value = TRUE)
    ],
    id.vars = c("const", "year_rated"),
    measure.vars = patterns("rating$"),
    variable.name = "who",
    value.name = "rating"
  )[
    j = who := factor(
      x = toupper(sub("your", "coeos", gsub("_.*", "", who))),
      levels = c("COEOS", "METASCORE", "IMDB"),
      labels = 1:3
    )
  ]

  p_ratings <- ggplot2::ggplot(data = ratings_long) +
    ggplot2::aes(
      x = rating,
      y = ggplot2::after_stat(count / tapply(count, group, sum)[group]),
      colour = who,
      fill = who
    ) +
    ggplot2::annotation_raster(
      raster = matrix(
        data = rep(scales::viridis_pal(option = "plasma", alpha = 0.10)(50), each = 50),
        nrow = 50
      ),
      xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
    ) +
    ggplot2::geom_bar(
      position = ggplot2::position_dodge2(width = 0.90, preserve = "single"),
      na.rm = TRUE,
      colour = NA
    ) +
    ggplot2::geom_text(
      mapping = ggplot2::aes(
        label = ggplot2::after_stat(percent(
          x = count / tapply(count, group, sum)[group],
          suffix = " %",
          accuracy = 0.1
        ))
      ),
      stat = "count",
      position = ggplot2::position_dodge2(width = 0.90, preserve = "single"),
      family = font,
      angle = 90,
      size = 3,
      hjust = -0.1,
      vjust = 0.5,
      na.rm = TRUE,
      show.legend = FALSE
    ) +
    ggplot2::scale_x_binned(
      limits = c(0, 10),
      right = FALSE,
      labels = function(x) ifelse(x %in% 10, x, paste0(x, "+")),
      expand = c(0, 0)
    ) +
    ggplot2::scale_y_continuous(
      labels = scales::percent_format(suffix = ""),
      expand = ggplot2::expansion(c(0, 0.15))
    ) +
    ggplot2::scale_colour_manual(values = unname(who_colours), labels = names(who_colours)) +
    ggplot2::scale_fill_manual(values = unname(who_colours), labels = names(who_colours)) +
    ggplot2::labs(
      x = "Rating",
      y = "Percentage of Movies (%)",
      colour = NULL,
      fill = NULL,
      title = sprintf(
        "Distribution of Ratings (N = %s)",
        ratings[j = format(uniqueN(const), big.mark = ",")]
      ),
      subtitle = text_legend,
      caption = fig_caption
    ) +
    ggplot2::theme(
      legend.position = "none",
      panel.grid.minor = ggplot2::element_blank()
    )

  if (static) {
    p_ratings + ggplot2::aes(group = who)
  } else {
    gganimate::animate(
      plot = p_ratings +
        ggplot2::aes(group = paste(who, year_rated, sep = "_")) +
        ggplot2::labs(
          title = 'Distribution of Ratings ({ratings[year_rated == closest_state, format(uniqueN(const), big.mark = ",")]}) in {closest_state}',
          subtitle = "{text_legend}"
        ) +
        gganimate::transition_states(year_rated, transition_length = 3, state_length = 6) +
        gganimate::enter_fade() +
        gganimate::exit_fade(),
      width = 6.3 * 2.54,
      height = 4.7 * 2.54,
      units = "cm",
      res = 120,
      bg = theme_get()$plot.background$colour,
      renderer = gganimate::gifski_renderer()
    )
  }
}

list(
  tar_target(theatres_raw_file, here("data", "theatres.csv"), format = "file"),
  tar_target(ratings_raw_file, here("data", "ratings.csv"), format = "file"),
  tar_target(theatres_raw_data, fread(file = theatres_raw_file)),
  tar_target(ratings_raw_data, {
    dt <- fread(file = ratings_raw_file, encoding = "Latin-1")
    setnames(dt, names(dt), gsub("[()]", "", gsub(" ", "_", tolower(names(dt)))))
    dt
  }),
  tar_target(theatres_complete_data, {
    theatres_raw_data[
      j = date := as.IDate(date_time)
    ][
      J(date = seq(min(date), today(), by = "1 day")),
      on = "date"
    ][
      j = c("month", "year", "wday") := list(
        as.character(month(date, label = TRUE, abbr = FALSE)),
        year(date),
        wday(date, label = TRUE, abbr = FALSE, week_start = 1)
      )
    ][
      j = year_complete := uniqueN(date) >= 365,
      by = "year"
    ]
  }),
  tar_target(ratings_complete_data, {
    ratings_raw_data[
      j = c("date_rated", "release_date") := lapply(.SD, as.IDate),
      .SDcols = c("date_rated", "release_date")
    ][
      j = c("month_rated", "year_rated") := list(
        month(date_rated, label = TRUE, abbr = FALSE),
        year(date_rated)
      )
    ]
  }),
  tar_target(add_metascore_ratings, 
    command = {
      path <- here("data", "ratings_ms.csv")
      if (file.exists(path)) {
        ratings_ms <- fread(file = path)[
          j = c("date_rated", "release_date") := lapply(.SD, as.IDate),
          .SDcols = c("date_rated", "release_date")
        ][
          date_rated < (today() - 100) | year < year(today())
        ]

        ratings_new <- ratings_complete_data[
          !const %in% ratings_ms[["const"]]
        ][
          j = metascore_rating := if (.N > 0) get_metascore(const) else NA
        ]

        fwrite(x = rbindlist(list(ratings_ms, ratings_new)), file = path)
      } else {
        fwrite(x = ratings_complete_data[j = metascore_rating := get_metascore(const)], file = path)
      }
      path
    }, 
    cue = tar_cue(mode = "always")
  ),
  tar_target(ratings_metascore_data, {
    fread(file = add_metascore_ratings)[
      j = c("date_rated", "release_date") := lapply(.SD, as.IDate),
      .SDcols = c("date_rated", "release_date")
    ][
      j = in_theatres := as.integer(const %in% ratings_complete_data[["imdb_id"]])
    ]
  }),
  tar_target(all_years_streak_plot, {
    all_years_streak_data <- theatres_complete_data[
      j = list(
        count = sum(!is.na(theatre)),
        month = sub("May.", "May", sprintf("%s.", as.character(month(date, label = TRUE, abbr = TRUE)))),
        year = year,
        month_num = month(date),
        wday = wday
      ),
      by = "date"
    ][
      j = week := fifelse(
        isoweek(date) == 1 & month_num == 12,
        max(isoweek(date)) + 1,
        fifelse(isoweek(date) > 5 & month_num == 1, 0, isoweek(date))
      ),
      by = "year"
    ][
      i = year %in% unique(year[week == 0]),
      j = week := week + 1
    ][
      j = week := factor(sprintf("%02d", week), ordered = TRUE)
    ][
      j = unique(.SD)
    ]

    week_month_breaks <- all_years_streak_data[
      i = wday == "Monday" & year > 2013,
      j = list(week = week, n = .N),
      by = c("month_num", "month")
    ][
      j = month_start := n == max(n) & as.numeric(week) == max(sort(unique(as.numeric(week)))[1:2]),
      by = c("month_num", "month")
    ][
      i = (month_start),
      j = unique(.SD),
      .SDcols = c("month_num", "month", "week", "n")
    ][
      order(month_num, week)
    ]

    ggplot(data = all_years_streak_data) +
      aes(
        x = week,
        y = factor(wday, levels = rev(levels(wday))),
        label = count
      ) +
      geom_tile(
        data = ~ .x[month_num %% 2 == 0],
        show.legend = FALSE,
        colour = NA, # "white",
        fill = "white",
        alpha = 0.05,
        width = 0.8,
        height = 0.8
      ) +
      geom_tile(
        mapping = aes(fill = count),
        alpha = 0.3,
        colour = "#FAFAFA66",
        size = 0.15,
        width = 0.8,
        height = 0.8,
        linejoin = "round"
      ) +
      geom_tile(
        data = ~ .x[
          between(date, ymd("2020-03-16"), ymd("2020-06-21")) | 
          between(date, ymd("2020-11-02"), ymd("2021-05-18"))
        ],
        fill = "#21908CFF",
        alpha = 0.3
      ) +
      geom_richtext(
        data = ~ .x[count != 0],
        colour = "#FAFAFA",
        na.rm = TRUE,
        family = font,
        fontface = "bold",
        size = 3.5,
        fill = NA,
        label.colour = NA
      ) +
      scale_x_discrete(
        expand = expansion(add = 0.25),
        breaks = week_month_breaks[["week"]],
        labels = week_month_breaks[["month"]]
      ) +
      scale_y_discrete(
        expand = expansion(add = 0.5),
        labels = function(x) sub("([[:alpha:]]{3}).*", "\\1.", x)
      ) +
      scale_colour_viridis_c() +
      scale_fill_viridis_c(
        begin = 0.25,
        end = 1,
        limits = c(1, NA),
        na.value = NA
      ) +
      theme(
        panel.grid = element_blank(),
        panel.border = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank(),
        plot.caption = element_markdown(face = "italic", size = rel(0.90)),
        strip.background = element_rect(colour = NA),
        strip.text = element_text(size = rel(1.2), face = "bold")
      ) +
      labs(
        title = sprintf(
          "Streak of Movies Seen in a Theatre (%s)",
          format(sum(all_years_streak_data$count), big.mark = ',')
        ),
        caption = fig_caption,
        colour = "Count",
        fill = "Count",
        x = NULL, # "Week Number",
        y = NULL # "Day"
      )
  }),
  tar_target(streak_data, 
    command = {
      theatres_raw_data[
        j = date := as.IDate(date_time)
      ][
        i = J(date = seq(min(date), today(), by = "1 day")),
        on = "date"
      ][
        between(date, today() - months(12), today())
      ][
        j = list(
          count = sum(!is.na(theatre)),
          month = sub("May.", "May", sprintf("%s.", as.character(month(date, label = TRUE, abbr = TRUE)))),
          year = year(date),
          month_num = month(date),
          wday = wday(date, label = TRUE, abbr = FALSE, week_start = 1)
        ),
        by = "date"
      ][
        i = order(date)
      ][
        i = wday %in% "Monday",
        j = x_week := seq_len(.N)
      ][
        j = x_week := nafill(x = x_week, type = "locf")
      ][
        i = order(date),
        j = `:=`(
          "x" = fifelse(test = x_week %in% NA_integer_, 0, x_week),
          "y" = factor(wday, levels = rev(levels(wday)))
        )
      ]
    },
    cue = tar_cue(mode = "always")
  ),
  tar_target(streak_plot, {
    week_month_breaks <- streak_data[
      j = .SD[.N == 7],
      by = c("year", "month", "x")
    ][
      j = list(week = max(unique(x)[1:2], na.rm = TRUE)),
      by = c("year", "month")
    ]

    ggplot(data = streak_data) +
      aes(x = x, y = y, label = count) +
      geom_tile(
        data = ~ .x[month_num %% 2 == 0],
        show.legend = FALSE,
        colour = NA, # "white",
        fill = "white",
        alpha = 0.05,
        width = 0.8,
        height = 0.8
      ) +
      geom_tile(
        mapping = aes(fill = count),
        alpha = 0.3,
        colour = "#FAFAFA66",
        size = 0.15,
        width = 0.8,
        height = 0.8,
        linejoin = "round"
      ) +
      geom_richtext(
        data = ~ .x[count != 0],
        colour = "#FAFAFA",
        na.rm = TRUE,
        family = font,
        fontface = "bold",
        size = 3.5,
        fill = NA,
        label.colour = NA
      ) +
      scale_x_continuous(
        expand = expansion(add = 0.25),
        breaks = week_month_breaks[["week"]],
        labels = week_month_breaks[["month"]],
        position = "top"
      ) +
      scale_y_discrete(
        expand = expansion(add = 0.5),
        labels = function(x) sub("([[:alpha:]]{3}).*", "\\1.", x)
      ) +
      scale_colour_viridis_c() +
      scale_fill_viridis_c(
        begin = 0.25,
        end = 1,
        limits = c(1, NA),
        na.value = NA
      ) +
      theme(
        panel.grid = element_blank(),
        panel.border = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank(),
        plot.caption = element_markdown(face = "italic", size = rel(0.90))
      ) +
      labs(
        caption = sprintf(
          "<b>%s movies seen</b> in a movie theatre <b>in the last year</b>.",
          format(sum(streak_data[["count"]]), nsmall = 0, big.mark = ",")
        )
      )
  }),
  tar_target(count_plot, {
    count_data <- theatres_raw_data[
      j = .N,
      by = list(
        "year" = year(date_time),
        month = month(date_time, label = TRUE, abbr = FALSE)
      )
    ][
      i = J(year = rep(unique(year), each = 12), month = unique(month)),
      on = c("year", "month")
    ][
      i = is.na(N),
      j = N := 0
    ][
      j = year := factor(year, levels = rev(unique(year)))
    ]
    ggplot(data = count_data) +
      aes(x = month, y = year, label = N) +
      geom_tile(
        mapping = aes(fill = N),
        alpha = 0.3,
        colour = "#FAFAFA66",
        size = 0.15,
        width = 0.8,
        height = 0.8,
        linejoin = "round"
      ) +
      geom_tile(
        data = ~ .x[which.max(N)],
        colour = "#FAFAFA66",
        fill = NA,
        size = 1,
        width = 0.8,
        height = 0.8,
        linejoin = "round"
      ) +
      geom_richtext(
        colour = "#FAFAFA",
        na.rm = TRUE,
        family = font,
        fontface = "bold",
        size = 3.5,
        fill = NA,
        label.colour = NA
      ) +
      scale_x_discrete(
        labels = function(x) {
          ifelse(
            x %in% unique(count_data[which.max(N), month]),
            sprintf("<b>%s</b>", x),
            x
          )
        },
        expand = expansion(add = 0.5),
        position = "top"
      ) +
      scale_y_discrete(
        labels = function(x) {
          ifelse(
            x %in% unique(count_data[which.max(N), year]),
            sprintf("<b>%s</b>", x),
            x
          )
        },
        expand = expansion(add = 0.5)
      ) +
      scale_fill_viridis_c(
        begin = 0,
        end = 0.80,
        limits = c(1, NA),
        na.value = NA
      ) +
      theme(
        legend.position = "none",
        panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank(),
        plot.caption = element_markdown(face = "italic", size = rel(0.90))
      ) +
      labs(
        caption = sprintf(
          "<b>%s movies seen</b> in <b>a movie theatre</b>.",
          format(sum(count_data[["N"]]), nsmall = 0, big.mark = ",")
        )
      )
  }),
  tar_target(ratings_theatres_plot, {
    ratings_histogram(
      ratings = merge(
        x = ratings_metascore_data[, -c("year_rated")],
        y = unique(theatres_complete_data[!is.na(imdb_id), list(const = imdb_id, year_rated = year(date))]),
        by = "const",
        all = FALSE
      ), 
      static = TRUE
    )
  }),
  tar_target(ratings_all_plot, {
    ratings_histogram(ratings = ratings_metascore_data, static = TRUE)
  })
)
```

```{r}
#| include: false
tar_make()
```

```{r streak}
#| fig.width: 8
#| fig.height: 1.75
#| fig.cap: "Movies seen in a movie theatre year streak"

tar_read(streak_plot)
```

```{r counts}
#| fig.width: 8
#| fig.height: 6.5
#| fig.cap: "Counts of movies seen in a movie theatre per month and year."

tar_read(count_plot)
```

```{r ratings}
#| fig.width: 8
#| fig.height: 6
#| fig.cap: "Ratings (as an histogram) of movies seen."
# fig.cap: "Ratings (as an histogram) of movies seen in a movie theatre (A; left figure) and/or anywhere (B; right figure)."

# plots <- list(
#   tar_read(ratings_theatres_plot),
#   tar_read(ratings_all_plot)
# )
# range_y_plots <- range(sapply(
#   X = plots,
#   FUN = function(p) {
#     ggplot_build(p)$layout$panel_scales_y[[1]]$range$range
#   }
# ))

# wrap_plots(lapply(plots, `+`, coord_cartesian(y = range_y_plots)), ncol = 2) +
#   plot_annotation(tag_levels = "A")

tar_read(ratings_all_plot)
```

```{r streak-years}
#| fig.width: 8
#| fig.height: 12
#| fig.cap: "Movies seen in a movie theatre year streak."

tar_read(all_years_streak_plot) +
  facet_grid(rows = vars(year))
```

```{r streak-years-animated}
#| eval: FALSE
#| fig.width: 8
#| fig.height: 1.75
#| fig.cap: "Animation of movies seen in a movie theatre year streak."

print(
  tar_read(all_years_streak_plot) +
    gganimate::transition_states(year),
  width = 8,
  height = 1.75,
  units = "in",
  res = 120,
  bg = theme_get()$plot.background$colour,
  renderer = gganimate::gifski_renderer(file = "media/streak-years-animated.gif"),
  device = "ragg_png"
)

# gganimate::animate(
#   plot = tar_read(all_years_streak_plot) +
#     transition_time(Year),
#   width = 8,
#   height = 1.75,
#   bg = theme_get()$plot.background$colour,
#   renderer = gganimate::gifski_renderer(),
#   device = "svglite"
# )
```
